<script>
  let isRegular = false; 
  let isEditMode = false;
  let currentBookingData = null;

  // 1. 初始化與守衛模式
  const checkGoogleLoaded = setInterval(() => {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      clearInterval(checkGoogleLoaded);
      initializeApp();
    }
  }, 100);

  function initializeApp() {
    const today = new Date().toISOString().split('T')[0];
    const datePicker = document.getElementById('datePicker');
    if (datePicker) datePicker.setAttribute('min', today);
    google.script.run.withSuccessHandler(populateServices).getServices();
    google.script.run.withSuccessHandler(populateTherapists).getTherapists();
  }

  // 2. 常客辨識邏輯 (離開 Email 欄位時觸發)
  document.getElementById('userEmail').onblur = function() {
    const email = this.value;
    const phone = document.getElementById('userPhone').value;
    if(email && phone.length >= 12) {
      google.script.run.withSuccessHandler(res => {
        isRegular = res.isRegular;
        const verifyGroup = document.getElementById('verifyGroup');
        const verifyMsg = document.getElementById('verifyMsg');
        if(isRegular) {
          verifyGroup.style.display = 'none';
          verifyMsg.innerText = "偵測到常客身分，免驗證。";
        } else {
          verifyGroup.style.display = 'block';
          verifyMsg.innerText = "";
        }
      }).checkRegularCustomer(email, phone); // 呼叫 Code.gs 的函式
    }
  };

  // 3. 表單提交總控
  document.getElementById('bookingForm').onsubmit = function(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerText = '處理中...';

    const email = document.getElementById('userEmail').value;
    const inputCode = document.getElementById('verifyCode').value;

    // 非修改模式且非常客才要驗證
    if (!isRegular && !isEditMode) {
      google.script.run.withSuccessHandler(isValid => {
        if (isValid) finalSubmit();
        else {
          showCustomAlert("首次預約請點擊「取得驗證碼」並輸入正確代碼。");
          btn.disabled = false;
          btn.innerText = '確認提交預約';
        }
      }).verifyCodeServerSide(email, inputCode);
    } else {
      finalSubmit();
    }
  };

  function finalSubmit() {
    const payload = {
      service: document.getElementById('serviceSelect').value,
      therapist: document.querySelector('input[name="therapist"]:checked').value,
      date: document.getElementById('datePicker').value,
      time: document.getElementById('selectedTime').value,
      name: document.getElementById('userName').value,
      phone: document.getElementById('userPhone').value,
      email: document.getElementById('userEmail').value,
      note: document.getElementById('userNote').value,
      isEdit: isEditMode,
      bookingId: isEditMode ? currentBookingData.bookingId : null
    };

    const functionName = isEditMode ? 'updateBooking' : 'processBooking';
    google.script.run
      .withSuccessHandler(res => {
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
        if (isEditMode) document.querySelector('#successModal h5').innerText = "預約修改成功";
        successModal.show();
      })
      .withFailureHandler(err => {
        showCustomAlert("系統錯誤：" + err.message);
        document.getElementById('submitBtn').disabled = false;
      })[functionName](payload);
  }

  // 4. 其餘介面輔助函式 (格式化、彈窗、搜尋等)
  document.getElementById('userPhone').addEventListener('input', function (e) {
    let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
    e.target.value = !x[2] ? x[1] : x[1] + '-' + x[2] + (x[3] ? '-' + x[3] : '');
  });

  function showCustomAlert(msg) {
    document.getElementById('alertMsg').innerText = msg;
    new bootstrap.Modal(document.getElementById('alertModal')).show();
  }
  
  // (其餘 goToStep, populateServices, handleSearch 等函式維持原樣...)
</script>
