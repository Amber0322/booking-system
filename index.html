<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>按摩工作室預約系統</title>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f7f6; font-family: "Microsoft JhengHei", sans-serif; }
    .step-section { display: none; }
    .step-section.active { display: block; animation: fadeIn 0.4s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .slot-btn { width: 100px; margin: 5px; }
    .slot-btn.selected { background-color: #0d6efd !important; color: white !important; }
    #loading { display: none; }
    .card { border-radius: 12px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .phone-input { background-color: #e9ecef !important; }
  </style>
</head>
<body>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card">
        <div class="card-body p-4">
          <h3 class="text-center mb-4">預約管理系統</h3>

          <div class="mb-4 text-center">
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="actionType" id="typeNew" value="new" checked onchange="toggleMode()">
              <label class="btn btn-outline-primary" for="typeNew">新增預約</label>
              <input type="radio" class="btn-check" name="actionType" id="typeEdit" value="edit" onchange="toggleMode()">
              <label class="btn btn-outline-primary" for="typeEdit">修改/取消</label>
            </div>
          </div>

          <form id="bookingForm">
            <div id="step1" class="step-section active">
              <h5 class="mb-3">Step 1: 選擇服務項目</h5>
              <select class="form-select form-select-lg" id="serviceSelect" required onchange="resetTimeSlots()">
                <option value="" selected disabled>載入項目中...</option>
              </select>
              <div class="d-grid mt-4">
                <button type="button" class="btn btn-primary" onclick="goToStep(2)">下一步</button>
              </div>
            </div>

            <div id="step2" class="step-section">
              <h5 class="mb-3">Step 2: 指定按摩師</h5>
              <div id="therapistSelect" class="list-group mb-3">
                <label class="list-group-item">
                  <input class="form-check-input me-1" type="radio" name="therapist" value="none" checked onchange="resetTimeSlots()">
                  不指定 (由系統分配)
                </label>
              </div>
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-light" onclick="goToStep(1)">上一步</button>
                <button type="button" class="btn btn-primary" onclick="goToStep(3)">下一步</button>
              </div>
            </div>

            <div id="step3" class="step-section">
              <h5 class="mb-3">Step 3: 選擇預約時間</h5>
              <label class="small text-muted">選擇日期</label>
              <input type="date" class="form-control mb-4" id="datePicker" onchange="fetchSlots()">
              
              <label class="small text-muted">可用時段)</label>
              <div id="loading" class="text-center my-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span class="ms-2">計算床位與人力中...</span>
              </div>
              <div id="slotContainer" class="d-flex flex-wrap justify-content-center border p-3 rounded bg-white" style="min-height: 80px;">
                <span class="text-muted">請先選擇日期</span>
              </div>
              
              <input type="hidden" id="selectedTime">
              <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-light" onclick="goToStep(2)">上一步</button>
                <button type="button" class="btn btn-primary" id="toStep5Btn" disabled onclick="goToStep(5)">最後一步</button>
              </div>
            </div>

            <div id="step5" class="step-section">
              <h5 class="mb-3">Step 4: 填寫資料</h5>
              <div class="mb-3">
                <input type="text" id="userName" class="form-control" placeholder="姓名 (必填)" required>
              </div>
              <div class="mb-3">
                <input type="tel" id="userPhone" class="form-control phone-input" placeholder="電話 (必填)" required>
                <div class="form-text text-muted small">格式自動轉換：XXX-XXX-XXXX</div>
              </div>
              <div class="mb-3">
                <input type="email" id="userEmail" class="form-control" placeholder="Email (必填)" required>
              </div>

              <div class="mb-3" id="verifyGroup">
                <div class="input-group">
                  <input type="text" id="verifyCode" class="form-control" placeholder="6 位驗證碼">
                  <button class="btn btn-outline-secondary" type="button" id="sendCodeBtn" onclick="handleSendCode()">取得驗證碼</button>
                </div>
                <div id="verifyMsg" class="form-text text-primary small mt-1"></div>
              </div>

              <div class="mb-3">
                <textarea id="userNote" class="form-control" placeholder="備註需求 (選填)"></textarea>
              </div>
              
              <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-light" onclick="goToStep(3)">上一步</button>
                <button type="submit" class="btn btn-success" id="submitBtn">確認提交預約</button>
              </div>
            </div>
          </form>

          <div id="editSection" class="step-section">
            <h5 class="mb-3">修改/取消預約</h5>
            <div id="editSearchArea">
              <div class="input-group mb-3">
                <input type="tel" id="searchPhone" class="form-control" placeholder="輸入預約電話">
                <button class="btn btn-primary" onclick="handleSearch()">搜尋</button>
              </div>
            </div>
            <div id="editVerifyArea" style="display:none;">
              <div class="alert alert-info small">驗證碼將寄至：<span id="displayMaskedEmail"></span></div>
              <div id="editActionButtons" class="mt-3" style="display:none;">
  <div class="d-grid gap-2">
    <button class="btn btn-primary btn-lg" onclick="handleModeSelection('modify')">修改預約</button>
    <button class="btn btn-outline-danger btn-lg" onclick="handleModeSelection('cancel')">取消預約</button>
  </div>
</div>

<div id="editListArea" class="mt-3" style="display:none;">
  <p class="text-muted small">請選擇您要管理的預約：</p>
  <div id="bookingListContainer" class="list-group"></div>
</div>

<div class="modal fade" id="confirmAbandonModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center p-4">
        <h5>確定要放棄修改嗎？</h5>
        <p class="text-muted">選擇 Yes 將維持原本的預約內容。</p>
        <div class="d-flex justify-content-center gap-3 mt-3">
          <button class="btn btn-success px-4" onclick="location.reload()">Yes (維持原樣)</button>
          <button class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">No (繼續修改)</button>
        </div>
      </div>
    </div>
  </div>
</div>
              <div class="input-group mb-3">
                <input type="text" id="editVerifyCode" class="form-control" placeholder="6 位驗證碼">
                <button class="btn btn-outline-secondary" onclick="sendEditCode()">取得驗證碼</button>
              </div>
              <button class="btn btn-success w-100" onclick="verifyEditCode()">驗證並進入修改</button>
            </div>
            <div id="editMsg" class="mt-3 text-danger small text-center"></div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">操作成功</h5>
        <button type="button" class="btn-close btn-close-white" onclick="location.reload()"></button>
      </div>
      <div class="modal-body text-center py-4">
        <p class="fs-5 mb-1">您的預約已處理完成！</p>
        <p class="text-muted">系統將於按摩前一天發送 Email 提醒您。</p>
      </div>
      <div class="modal-footer justify-content-center border-0">
        <button type="button" class="btn btn-primary px-5" onclick="location.reload()">確定</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-body text-center py-4">
        <div class="text-danger mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-exclamation-circle" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
          </svg>
        </div>
        <p id="alertMsg" class="mb-4 fw-bold text-secondary"></p>
        <button type="button" class="btn btn-outline-secondary btn-sm px-4" data-bs-dismiss="modal">確定</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let isRegular = false; 
  let isEditMode = false;
  let currentBookingData = null;

  // 1. 初始化與守衛模式
  const checkGoogleLoaded = setInterval(() => {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      clearInterval(checkGoogleLoaded);
      console.log("GAS 環境就緒，時區：Winnipeg (GMT-6)");
      initializeApp();
    }
  }, 100);

  function initializeApp() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('datePicker').setAttribute('min', today);
    google.script.run.withSuccessHandler(populateServices).getServices();
    google.script.run.withSuccessHandler(populateTherapists).getTherapists();
  }

  // 2. 常客自動辨識 (離開 Email 欄位時觸發)
  document.getElementById('userEmail').onblur = function() {
    const email = this.value;
    const phone = document.getElementById('userPhone').value;
    if(email && phone.length >= 12) {
      google.script.run.withSuccessHandler(res => {
        isRegular = res.isRegular;
        const vGroup = document.getElementById('verifyGroup');
        const vMsg = document.getElementById('verifyMsg');
        if(isRegular) {
          vGroup.style.display = 'none';
          vMsg.innerText = "✨ 偵測到常客身分，免驗證。";
        } else {
          vGroup.style.display = 'block';
          vMsg.innerText = "";
        }
      }).checkRegularCustomer(email, phone);
    }
  };

  // 3. 表單提交總控
  document.getElementById('bookingForm').onsubmit = function(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerText = '正在處理預約...';

    const email = document.getElementById('userEmail').value;
    const inputCode = document.getElementById('verifyCode').value;

    if (!isRegular && !isEditMode) {
      if (!inputCode) {
        showCustomAlert("首次預約請先取得並輸入驗證碼。");
        btn.disabled = false; btn.innerText = '確認提交預約';
        return;
      }
      google.script.run.withSuccessHandler(isValid => {
        if (isValid) finalSubmit();
        else {
          showCustomAlert("驗證碼錯誤，請重新確認。");
          btn.disabled = false; btn.innerText = '確認提交預約';
        }
      }).verifyCodeServerSide(email, inputCode);
    } else {
      finalSubmit();
    }
  };

  function finalSubmit() {
    const payload = {
      service: document.getElementById('serviceSelect').value,
      therapist: document.querySelector('input[name="therapist"]:checked').value,
      date: document.getElementById('datePicker').value,
      time: document.getElementById('selectedTime').value,
      name: document.getElementById('userName').value,
      phone: document.getElementById('userPhone').value,
      email: document.getElementById('userEmail').value,
      note: document.getElementById('userNote').value,
      isEdit: isEditMode,
      bookingId: isEditMode ? currentBookingData.bookingId : null
    };

    const functionName = isEditMode ? 'updateBooking' : 'processBooking';
    google.script.run
      .withSuccessHandler(res => {
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
        successModal.show();
      })
      .withFailureHandler(err => {
        showCustomAlert("系統錯誤：" + err.message);
        document.getElementById('submitBtn').disabled = false;
      })[functionName](payload);
  }

  // 4. 修改流程函式
  function handleSearch() {
    const phone = document.getElementById('searchPhone').value;
    google.script.run.withSuccessHandler(res => {
      if (res.success) {
        currentBookingData = res;
        document.getElementById('editSearchArea').style.display = 'none';
        document.getElementById('editVerifyArea').style.display = 'block';
        document.getElementById('displayMaskedEmail').innerText = res.maskedEmail;
      } else { showCustomAlert(res.msg); }
    }).searchBookingForEdit(phone);
  }

  function sendEditCode() {
    google.script.run.withSuccessHandler(() => showCustomAlert("驗證碼已寄出。"))
      .sendVerificationCode(currentBookingData.fullEmail, currentBookingData.name);
  }

  function verifyEditCode() {
    const code = document.getElementById('editVerifyCode').value;
    google.script.run.withSuccessHandler(isValid => {
      if (isValid) {
        document.getElementById('editVerifyArea').style.display = 'none';
        isEditMode = true;
        showCustomAlert("身分驗證成功，請重新選時段。");
        goToStep(1);
      } else { showCustomAlert("驗證碼錯誤。"); }
    }).verifyCodeServerSide(currentBookingData.fullEmail, code);
  }

  // 5. 工具函式
  function populateServices(data) {
    const select = document.getElementById('serviceSelect');
    select.innerHTML = '<option value="" selected disabled>請選擇項目...</option>';
    data.forEach(item => select.add(new Option(`${item.name} (${item.duration}min)`, item.name)));
  }

  function populateTherapists(staff) {
    const container = document.getElementById('therapistSelect');
    staff.forEach(person => {
      const html = `<label class="list-group-item"><input class="form-check-input me-1" type="radio" name="therapist" value="${person.name}" onchange="resetTimeSlots()">${person.name}</label>`;
      container.insertAdjacentHTML('beforeend', html);
    });
  }

  function fetchSlots() {
    const service = document.getElementById('serviceSelect').value;
    const date = document.getElementById('datePicker').value;
    const therapist = document.querySelector('input[name="therapist"]:checked').value;
    if(!service) { showCustomAlert('請先選擇服務項目'); return; }
    document.getElementById('loading').style.display = 'block';
    document.getElementById('slotContainer').innerHTML = '';
    google.script.run.withSuccessHandler(renderSlots).getAvailableSlots(service, therapist, date);
  }

  function renderSlots(slots) {
    document.getElementById('loading').style.display = 'none';
    const container = document.getElementById('slotContainer');
    if(!slots || slots.length === 0) { container.innerHTML = '<span class="text-danger">該日已無可用時段。</span>'; return; }
    slots.forEach(time => {
      const btn = document.createElement('button');
      btn.className = 'btn btn-outline-primary slot-btn'; btn.innerText = time;
      btn.onclick = function() {
        document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected'); document.getElementById('selectedTime').value = time;
        document.getElementById('toStep5Btn').disabled = false;
      };
      container.appendChild(btn);
    });
  }

  function handleSendCode() {
    const email = document.getElementById('userEmail').value;
    const name = document.getElementById('userName').value;
    if(!email || !name) { showCustomAlert("請填寫姓名與 Email。"); return; }
    const btn = document.getElementById('sendCodeBtn'); btn.disabled = true;
    google.script.run.withSuccessHandler(() => {
      document.getElementById('verifyMsg').innerText = "驗證碼已寄出";
      let sec = 60; const timer = setInterval(() => {
        btn.innerText = `${sec--}s`; if(sec < 0) { clearInterval(timer); btn.disabled = false; btn.innerText = "取得驗證碼"; }
      }, 1000);
    }).sendVerificationCode(email, name);
  }

  function goToStep(step) {
    document.querySelectorAll('.step-section').forEach(s => s.classList.remove('active'));
    document.getElementById('step' + step).classList.add('active');
  }

  function toggleMode() {
    isEditMode = document.getElementById('typeEdit').checked;
    document.getElementById('bookingForm').style.display = isEditMode ? 'none' : 'block';
    document.getElementById('editSection').classList.toggle('active', isEditMode);
    if(!isEditMode) goToStep(1);
  }

  function resetTimeSlots() {
    document.getElementById('slotContainer').innerHTML = '<span class="text-muted">請重新選擇日期</span>';
    document.getElementById('datePicker').value = ''; document.getElementById('toStep5Btn').disabled = true;
  }

  function showCustomAlert(msg) {
    document.getElementById('alertMsg').innerText = msg;
    new bootstrap.Modal(document.getElementById('alertModal')).show();
  }

  document.getElementById('userPhone').addEventListener('input', function (e) {
    let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
    e.target.value = !x[2] ? x[1] : x[1] + '-' + x[2] + (x[3] ? '-' + x[3] : '');
  });

  let selectedBooking = null; // 儲存客人目前選中的那一筆資料

/**
 * 驗證成功後，決定顯示列表還是直接進入
 */
function verifyEditCode() {
  const code = document.getElementById('editVerifyCode').value;
  google.script.run.withSuccessHandler(isValid => {
    if (isValid) {
      document.getElementById('editVerifyArea').style.display = 'none';
      renderBookingList(); // 渲染清單供客人選擇
    } else {
      showCustomAlert("驗證碼錯誤。");
    }
  }).verifyCodeServerSide(currentBookingData.fullEmail, code);
}

/**
 * 渲染預約清單 (處理多人預約)
 */
function renderBookingList() {
  const container = document.getElementById('bookingListContainer');
  container.innerHTML = '';
  
  currentBookingData.bookings.forEach(b => {
    const btn = document.createElement('button');
    btn.className = 'list-group-item list-group-item-action p-3';
    btn.innerHTML = `
      <div class="d-flex justify-content-between">
        <strong>${b.name}</strong>
        <span class="badge bg-primary">${b.time}</span>
      </div>
      <div class="small text-muted">${b.date} - ${b.service}</div>
    `;
    btn.onclick = () => {
      selectedBooking = b;
      document.getElementById('editListArea').style.display = 'none';
      document.getElementById('editActionButtons').style.display = 'block';
    };
    container.appendChild(btn);
  });
  document.getElementById('editListArea').style.display = 'block';
}

/**
 * 處理 修改 或 取消 按鈕點擊
 */
function handleModeSelection(mode) {
  if (mode === 'cancel') {
    showCustomAlert("如需取消預約，請致電工作室 333-444-5555。"); // 取消導引
  } else {
    // 檢查修改次數
    if (selectedBooking.editCount >= 1) {
      showCustomAlert("此預約已修改過一次，請致電工作室處理。"); // 修改限制
      return;
    }
    isEditMode = true;
    currentBookingData.bookingId = selectedBooking.bookingId; // 鎖定 ID
    showCustomAlert("驗證成功！請重新選擇服務項目與時段。");
    goToStep(1);
    addAbandonGuard(); // 開啟放棄修改監控
  }
}

/**
 * 放棄修改攔截邏輯
 */
function addAbandonGuard() {
  // 修改導覽按鈕，點擊原本的「新增預約」或「修改/取消」時跳出詢問
  document.querySelectorAll('input[name="actionType"]').forEach(input => {
    input.onclick = function(e) {
      if (isEditMode) {
        e.preventDefault();
        new bootstrap.Modal(document.getElementById('confirmAbandonModal')).show();
      }
    };
  });
}
</script>

</body>
</html>
